<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard de Pedidos</title>

<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

<style>
/* ===== RESET & BASE ===== */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
Â  Â  font-family: 'Inter', sans-serif; 
Â  Â  background-color: #f6f8fb; 
Â  Â  color: #333; 
Â  Â  display: flex; 
Â  Â  height: 100vh; 
Â  Â  overflow: hidden; 
}

/* ===== SIDEBAR ===== */
.sidebar { 
Â  Â  width: 250px; 
Â  Â  background: linear-gradient(180deg, #1e3a8a 0%, #0f172a 100%); 
Â  Â  color: #fff; 
Â  Â  display: flex; 
Â  Â  flex-direction: column; 
Â  Â  padding: 25px 0; 
Â  Â  box-shadow: 3px 0 10px rgba(0,0,0,0.1); 
}
.sidebar h2 { 
Â  Â  font-family: 'Poppins', sans-serif; 
Â  Â  font-size: 24px; 
Â  Â  text-align: center; 
Â  Â  margin-bottom: 40px; 
Â  Â  font-weight: 600;
}
.sidebar nav { display: flex; flex-direction: column; gap: 10px; }
.sidebar nav a { 
Â  Â  color: #cbd5e1; padding: 15px 25px; text-decoration: none; font-weight: 500; 
Â  Â  transition: 0.3s; display: flex; align-items: center; gap: 12px; font-size: 15px;
}
.sidebar nav a:hover { background: rgba(255,255,255,0.1); color: #fff; border-right: 4px solid #3b82f6; }
.sidebar footer { margin-top: auto; padding: 20px; font-size: 12px; text-align: center; opacity: 0.6; }

/* ===== MAIN ===== */
.main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }

/* ===== TOPBAR ===== */
.topbar { 
Â  Â  background: #fff; padding: 15px 30px; display: flex; justify-content: space-between; 
Â  Â  align-items: center; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; 
}
.topbar-left { display: flex; align-items: center; gap: 20px; flex-direction: row-reverse; }
.topbar h1 { font-family: 'Poppins', sans-serif; color: #1e3a8a; font-size: 22px; margin-left: 20px; }
#valorTotal { 
Â  Â  font-weight: 600; font-size: 15px; color: #1e3a8a; background: #e0e7ff; 
Â  Â  padding: 8px 16px; border-radius: 6px; border: 1px solid #c7d2fe;
}

/* ===== CONTENT & GRID ===== */
.content { padding: 30px; overflow-y: auto; }
.dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px; align-items: start; }
@media (min-width: 1400px) { .dashboard-grid { grid-template-columns: minmax(320px, 1fr) minmax(320px, 1fr) minmax(320px, 1fr); } }

/* ===== CARDS ===== */
.card { 
Â  Â  background: #fff; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.04); 
Â  Â  padding: 20px; transition: transform 0.2s ease, box-shadow 0.2s ease; margin-bottom: 20px; border: 1px solid #f1f5f9;
}
.card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(0,0,0,0.08); }
.card h3 { color: #1e3a8a; font-size: 16px; margin-bottom: 15px; font-weight: 600; }

/* ===== CARD HEADER COM FILTROS (NOVO) ===== */
.card-header {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  margin-bottom: 15px;
Â  Â  flex-wrap: wrap;
Â  Â  gap: 10px;
}
.card-header h3 { margin-bottom: 0; white-space: nowrap; }
.card-filters { display: flex; gap: 8px; }
.filter-select, .filter-input {
Â  Â  padding: 5px 8px;
Â  Â  border-radius: 6px;
Â  Â  border: 1px solid #cbd5e1;
Â  Â  font-size: 12px;
Â  Â  background: #fff;
Â  Â  color: #333;
}
.filter-input { width: 70px; } /* Largura pequena para o input de dias */

/* ===== CHART FIX ===== */
.chart-wrapper { position: relative; height: 250px; width: 100%; overflow: hidden; }

/* ===== METRICS ===== */
.metrics { display: flex; gap: 20px; margin-bottom: 20px; }
.metrics .card { text-align: center; padding: 20px; flex: 1; margin-bottom: 0; }
.metrics .card p { font-size: 32px; font-weight: bold; color: #1e3a8a; margin-top: 5px; }

/* ===== LISTS ===== */
#pedidoLista ul, #listaItensPedido { list-style: none; padding: 0; margin: 0; max-height: 280px; overflow-y: auto; }
#pedidoLista li { 
Â  Â  padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; background: #fff; 
Â  Â  font-weight: 500; color: #334155; border: 1px solid #e2e8f0; transition: all 0.2s; 
Â  Â  cursor: pointer; font-size: 14px;
}
#pedidoLista li:hover { background: #eff6ff; border-color: #3b82f6; color: #1e3a8a; }

/* ===== LOG ===== */
#logDash { 
Â  Â  background: #0f172a; color: #10b981; font-family: 'Courier New', monospace; 
Â  Â  font-size: 12px; padding: 15px; border-radius: 10px; height: 220px; 
Â  Â  overflow-y: auto; border: 1px solid #1e293b;
}

/* ===== OVERLAYS ===== */
.overlay-container {
Â  Â  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
Â  Â  background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; 
Â  Â  opacity: 0; transition: opacity 0.3s ease;
}
.overlay-content {
Â  Â  background: #fff; padding: 30px; border-radius: 14px; width: 90%; max-width: 700px; 
Â  Â  max-height: 90vh; overflow-y: auto; position: relative; transform: translateY(-50px); 
Â  Â  transition: transform 0.3s ease; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}
.close-btn {
Â  Â  position: absolute; top: 15px; right: 15px; background: #fee2e2; color: #ef4444; 
Â  Â  border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; 
Â  Â  font-weight: bold; display: flex; justify-content: center; align-items: center; transition: 0.2s;
}
.close-btn:hover { background: #ef4444; color: #fff; }

.btn-choose { 
Â  Â  background: #3b82f6; color: #fff; padding: 8px 16px; border-radius: 6px; border: none; 
Â  Â  cursor: pointer; font-weight: 500; transition: 0.2s; font-size: 13px;
}
.btn-choose:hover { background: #2563eb; }
.btn-choose:disabled { background: #94a3b8; cursor: not-allowed; }

.upload-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.status-pend { color: #ef4444; font-weight: 600; font-size: 13px; margin-left: 5px; }
.status-ok { color: #10b981; font-weight: 600; font-size: 13px; margin-left: 5px; }
.upload-msg { margin: 15px 0 5px 0; font-size: 14px; color: #475569; }

/* ===== ESTILOS DA RECORRÃŠNCIA ===== */
.kpi-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
.kpi-card { 
Â  Â  flex: 1; min-width: 150px; padding: 15px; border-radius: 8px; text-align: center; 
Â  Â  font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}
.kpi-card strong { display: block; font-size: 20px; margin-bottom: 4px; }
.kpi-green { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
.kpi-blue Â { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
.kpi-orange{ background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }

.filter-bar {
Â  Â  display: flex; align-items: center; justify-content: space-between; background: #f8fafc;
Â  Â  padding: 10px 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px;
Â  Â  gap: 15px; flex-wrap: wrap;
}
.filter-group { display: flex; align-items: center; gap: 10px; font-size: 14px; color: #475569; }
.filter-group select { padding: 6px 10px; border-radius: 6px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; }

/* Switch Toggle */
.toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider {
Â  Â  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background-color: #cbd5e1; transition: .4s; border-radius: 34px;
}
.slider:before {
Â  Â  position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
Â  Â  background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: #3b82f6; }
input:checked + .slider:before { transform: translateX(18px); }

#recorrenciaTable { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
#recorrenciaTable th, #recorrenciaTable td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
#recorrenciaTable th { background-color: #f8fafc; color: #1e3a8a; font-weight: 600; }
#recorrenciaTable tr:hover { background-color: #f1f5f9; }

/* Responsivo */
@media (max-width: 1100px) {
Â  Â  .dashboard-grid { grid-template-columns: 1fr; }
Â  Â  .sidebar { display: none; }
Â  Â  .topbar-left { flex-direction: row; }
}
</style>
</head>

<body>

Â  <aside class="sidebar">
Â  Â  <h2>Pedidos</h2>
Â  Â  <nav>
Â  Â  Â  <a href="#" onclick="abrirOverlay('overlayImport'); return false;">
Â  Â  Â  Â  <span>ğŸ“</span> Importar Planilhas
Â  Â  Â  </a>
Â  Â  Â  <a href="#" onclick="abrirOverlayHistorico(); return false;">
Â  Â  Â  Â  <span>ğŸ“‹</span> HistÃ³rico
Â  Â  Â  </a>
Â  Â  Â  <a href="#" onclick="abrirOverlay('overlayFaturamento'); gerarGraficoFaturamento(); return false;">
Â  Â  Â  Â  <span>ğŸ’°</span> Faturamento
Â  Â  Â  </a>
Â  Â  Â  <a href="#" onclick="abrirOverlayRecorrencia(); return false;">
Â  Â  Â  Â  <span>ğŸ‘¥</span> RecorrÃªncia
Â  Â  Â  </a>
Â  Â  </nav>
Â  Â  <footer>Â© 2025 Empresa XYZ</footer>
Â  </aside>

Â  <main class="main">
Â  Â  <header class="topbar">
Â  Â  Â  <div id="valorTotal">Valor Total: R$ 0,00</div>
Â  Â  Â  <div class="topbar-left">
Â  Â  Â  Â  <h1>Dashboard de Pedidos</h1>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <section class="content">
Â  Â  Â  <div class="dashboard-grid">
Â  Â  Â  Â  
Â  Â  Â  Â  <div class="coluna">
Â  Â  Â  Â  Â  <div id="pedidoLista" class="card">
Â  Â  Â  Â  Â  Â  <div class="card-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Pedidos</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="card-filters">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="filtroVelocidadeLista" class="filter-select" title="Filtrar por Velocidade">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Todos">Todos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="RÃ¡pido">RÃ¡pido</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="MÃ©dio">MÃ©dio</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Lento">Lento</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="filtroDiasLista" class="filter-input" placeholder="Dias..." title="Filtrar por quantidade exata de dias">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <ul id="listaPedidos"></ul>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div id="itensPedido" class="card">
Â  Â  Â  Â  Â  Â  <h3>Itens no Pedido</h3>
Â  Â  Â  Â  Â  Â  <ul id="listaItensPedido">
Â  Â  Â  Â  Â  Â  Â  Â  <li style="text-align:center; color:#999; border:none; cursor:default;">Selecione um pedido acima</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="coluna">
Â  Â  Â  Â  Â  <div class="metrics">
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  <h3>Dias MÃ©dios</h3>
Â  Â  Â  Â  Â  Â  Â  <p id="diasMedios">0.0</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  Â  <h3>% no Prazo</h3>
Â  Â  Â  Â  Â  Â  Â  <p id="pedidosNoPrazo">0%</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h3>Velocidade de Entrega</h3>
Â  Â  Â  Â  Â  Â  <div class="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="velocidadeChart"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="coluna">
Â  Â  Â  Â  Â  <div id="logDash" class="card" style="padding:0;">
Â  Â  Â  Â  Â  Â  <div style="padding:15px; border-bottom:1px solid #1e293b; background:#020617; border-radius:10px 10px 0 0;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:#fff; font-weight:bold;">System Log</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="logContent" style="padding:15px; white-space:pre-wrap;"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  Â  <h3>AnÃ¡lise MÃªs a MÃªs</h3>
Â  Â  Â  Â  Â  Â  <div class="chart-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="graficoMes"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  </div>
Â  Â  </section>
Â  </main>

Â  <div id="overlayImport" class="overlay-container">
Â  Â  <div class="overlay-content">
Â  Â  Â  <button class="close-btn" onclick="fecharOverlay('overlayImport')">âœ•</button>
Â  Â  Â  <h3 style="margin-bottom:20px; color:#1e3a8a;">Etapa 1 â€” Inserir Planilhas</h3>
Â  Â  Â  
Â  Â  Â  <p class="upload-msg"><strong>1. HistÃ³rico de Vendas B.I por Nota</strong></p>
Â  Â  Â  <div class="upload-row">
Â  Â  Â  Â  Â  <label class="btn-choose" for="planilhaNota">Escolher arquivo</label>
Â  Â  Â  Â  Â  <input type="file" id="planilhaNota" accept=".xlsx,.xls,.csv" style="display: none;" />
Â  Â  Â  Â  Â  <button class="btn-choose" style="background:#64748b;" onclick="gerarModelo('nota')">Baixar Modelo</button>
Â  Â  Â  Â  Â  <span id="statusNota" class="status-pend">âŒ Pendente</span>
Â  Â  Â  </div>

Â  Â  Â  <p class="upload-msg"><strong>2. HistÃ³rico de Vendas B.I por Produto</strong></p>
Â  Â  Â  <div class="upload-row">
Â  Â  Â  Â  Â  <label class="btn-choose" for="planilhaProduto">Escolher arquivo</label>
Â  Â  Â  Â  Â  <input type="file" id="planilhaProduto" accept=".xlsx,.xls,.csv" style="display: none;"/>
Â  Â  Â  Â  Â  <button class="btn-choose" style="background:#64748b;" onclick="gerarModelo('produto')">Baixar Modelo</button>
Â  Â  Â  Â  Â  <span id="statusProduto" class="status-pend">âŒ Pendente</span>
Â  Â  Â  </div>

Â  Â  Â  <p class="upload-msg"><strong>3. RelatÃ³rio de Produtos Site</strong></p>
Â  Â  Â  <div class="upload-row">
Â  Â  Â  Â  Â  <label class="btn-choose" for="planilhaSite">Escolher arquivo</label>
Â  Â  Â  Â  Â  <input type="file" id="planilhaSite" accept=".xlsx,.xls,.csv" style="display: none;"/>
Â  Â  Â  Â  Â  <button class="btn-choose" style="background:#64748b;" onclick="gerarModelo('site')">Baixar Modelo</button>
Â  Â  Â  Â  Â  <span id="statusSite" class="status-pend">âŒ Pendente</span>
Â  Â  Â  </div>

Â  Â  Â  <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;" />
Â  Â  Â  <button id="gerarAnalise" class="btn-choose" disabled style="width:100%; padding:12px; font-size:16px;">Gerar Dashboard</button>
Â  Â  </div>
Â  </div>

Â  <div id="overlayFaturamento" class="overlay-container">
Â  Â  <div class="overlay-content" style="max-width: 900px;">
Â  Â  Â  Â  <button class="close-btn" onclick="fecharOverlay('overlayFaturamento')">âœ•</button>
Â  Â  Â  Â  <h2 style="text-align:center; color:#1e3a8a; margin-bottom:20px;">EvoluÃ§Ã£o do Faturamento</h2>
Â  Â  Â  Â  <div id="faturamentoInsight" style="display:none; background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px; justify-content:space-between; align-items:center;">
Â  Â  Â  Â  Â  Â  Â <div id="insightMain" style="font-weight:700; color:#0f172a;">--</div>
Â  Â  Â  Â  Â  Â  Â <div id="insightDelta" style="font-weight:700;"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <canvas id="graficoFaturamento"></canvas>
Â  Â  </div>
Â  </div>
Â  
Â  <div id="overlayRecorrencia" class="overlay-container">
Â  Â  <div class="overlay-content" style="max-width: 800px;">
Â  Â  Â  Â  <button class="close-btn" onclick="fecharOverlay('overlayRecorrencia')">âœ•</button>
Â  Â  Â  Â  <h3 style="color:#1e3a8a; margin-bottom:15px;">ğŸ‘¥ AnÃ¡lise de RecorrÃªncia de Clientes</h3>
Â  Â  Â  Â  <div style="background:#f0f9ff; padding:15px; border-radius:8px; border:1px solid #bae6fd; margin-bottom:20px;">
Â  Â  Â  Â  Â  <p style="margin-bottom:10px; font-size:14px;">Importe uma planilha contendo as colunas <strong>Cliente</strong> e <strong>Valor</strong>.</p>
Â  Â  Â  Â  Â  <div class="upload-row" style="margin-bottom:0;">
Â  Â  Â  Â  Â  Â  Â  <label class="btn-choose" for="arquivoRecorrencia">Escolher Planilha</label>
Â  Â  Â  Â  Â  Â  Â  <input type="file" id="arquivoRecorrencia" accept=".xlsx,.xls,.csv" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  <button class="btn-choose" onclick="processarPlanilhaRecorrencia()">Analisar Agora</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="recorrenciaResultados" style="display:none;">
Â  Â  Â  Â  Â  Â  <div class="kpi-row">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card kpi-green"><strong id="kpiClientesUnicos">0</strong> Clientes Ãšnicos</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card kpi-blue"><strong id="kpiRecorrentes">0</strong> Recorrentes (>1 pedido)</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="kpi-card kpi-orange"><strong id="kpiTotalPedidos">0</strong> Total Pedidos Analisados</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="filter-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="toggle-switch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="checkApenasRecorrentes" onchange="renderizarTabelaRecorrencia()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="slider"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="checkApenasRecorrentes" style="cursor:pointer; font-weight:500;">Apenas Recorrentes</label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Ordenar por:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="selectOrdenacao" onchange="renderizarTabelaRecorrencia()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="valor">ğŸ’° Maior Valor Gasto</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pedidos">ğŸ“¦ Mais Pedidos</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="tabelaRecorrenciaWrapper"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="recorrenciaMsg"></div>
Â  Â  </div>
Â  </div>

Â  <div id="overlayHistorico" class="overlay-container">
Â  Â  Â  <div class="overlay-content" style="max-width: 400px;">
Â  Â  Â  Â  <button class="close-btn" onclick="fecharOverlay('overlayHistorico')">âœ•</button>
Â  Â  Â  Â  <h3 style="color:#1e3a8a; margin-bottom:15px;">HistÃ³rico de ImportaÃ§Ãµes</h3>
Â  Â  Â  Â  <ul id="listaHistorico" style="list-style:none;"></ul>
Â  Â  Â  </div>
Â  Â  </div>

<script>
/* ============================================================
Â  Â VARIÃVEIS GLOBAIS
Â  Â ============================================================ */
const diasMediosEl = document.getElementById('diasMedios');
const pedidosNoPrazoEl = document.getElementById('pedidosNoPrazo');
const listaPedidosEl = document.getElementById('listaPedidos');
const listaItens = document.getElementById('listaItensPedido');
const logDashEl = document.getElementById('logContent');

// Filtros da Lista de Pedidos
const filtroVelocidadeEl = document.getElementById('filtroVelocidadeLista');
const filtroDiasEl = document.getElementById('filtroDiasLista');

let historico_por_nota = [];
let historico_por_produto = [];
let site = [];
let produtosEnriquecidos = [];
let pedidos = [];
let pedidosOriginais = [];

let graficoMes = null;
let graficoFaturamento = null;
let chartVelocidade = null;

let historicoDashboards = JSON.parse(localStorage.getItem('historicoDashboards')||'[]');

/* ============================================================
Â  Â FUNÃ‡Ã•ES AUXILIARES
Â  Â ============================================================ */
function log(msg){
Â  Â  const time = new Date().toLocaleTimeString();
Â  Â  logDashEl.innerHTML += `[${time}] ${msg}\n`;
Â  Â  logDashEl.scrollTop = logDashEl.scrollHeight;
}

function base64ToArrayBuffer(base64){
Â  Â  if(!base64) return null;
Â  Â  const binary = atob(base64);
Â  Â  const buffer = new Uint8Array(binary.length);
Â  Â  for(let i=0;i<binary.length;i++) buffer[i] = binary.charCodeAt(i);
Â  Â  return buffer;
}

function removeAccents(s){
Â  Â  return s ? s.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : s;
}

function normalizeStr(s){
Â  Â  return removeAccents(String(s||'')).trim().toLowerCase().replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,' ');
}

function formatCurrency(v){
Â  Â  return v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
}

function parseMoneyRaw(v){
Â  Â  if(v === null || v === undefined) return 0;
Â  Â  const s = String(v).trim();
Â  Â  if(s === '') return 0;
Â  Â  let only = s.replace(/\s/g,'').replace(/[a-zA-Z$]/g,'');
Â  Â  if(only.includes(',') && !only.includes('.')) {
Â  Â  Â  Â  only = only.replace(',', '.');
Â  Â  } else if(only.includes('.') && only.includes(',')) {
Â  Â  Â  Â  if(only.indexOf('.') < only.indexOf(',')) {
Â  Â  Â  Â  Â  Â  only = only.replace(/\./g, '').replace(',', '.');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  only = only.replace(/,/g, '');
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return parseFloat(only) || 0;
}

function parseExcelDate(value){
Â  Â  if(!value && value !== 0) return null;
Â  Â  if(value instanceof Date) return value;
Â  Â  if(typeof value === 'number'){
Â  Â  Â  Â  return new Date(Math.round((value - 25569) * 86400 * 1000));
Â  Â  }
Â  Â  if(typeof value === 'string'){
Â  Â  Â  Â  const s = value.trim();
Â  Â  Â  Â  const parts = s.split('/');
Â  Â  Â  Â  if(parts.length===3){
Â  Â  Â  Â  Â  Â  const d = parseInt(parts[0],10), m = parseInt(parts[1],10)-1, y = parseInt(parts[2],10);
Â  Â  Â  Â  Â  Â  if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y,m,d);
Â  Â  Â  Â  }
Â  Â  Â  Â  const parsed = Date.parse(s);
Â  Â  Â  Â  if(!isNaN(parsed)) return new Date(parsed);
Â  Â  }
Â  Â  return null;
}

function calcularDias(emissao, saida) {
Â  Â  if (!emissao || !saida) return 0;
Â  Â  let diasUteis = 0;
Â  Â  let atual = new Date(emissao);
Â  Â  atual.setHours(0, 0, 0, 0);
Â  Â  saida.setHours(0, 0, 0, 0);
Â  Â  while (atual < saida) {
Â  Â  Â  Â  const diaSemana = atual.getDay();
Â  Â  Â  Â  if (diaSemana !== 0 && diaSemana !== 6) diasUteis++;
Â  Â  Â  Â  atual.setDate(atual.getDate() + 1);
Â  Â  }
Â  Â  return diasUteis;
}

/* ============================================================
Â  Â HEADER MAPPING (MANTIDO)
Â  Â ============================================================ */
const headerCandidates = {
Â  nota: ['nota','numero nota','nro nota','nota fiscal','nÂº nota','num nota'],
Â  pedido_internet: ['pedido internet','pedido_internet','pedidointernet','pedido','pedido id','pedidoid'],
Â  dt_emissao: ['dt emissao','data emissao','dt_emissao','data_emissao','data de emissao'],
Â  dt_saida: ['dt saida','data saida','dt_saida','data_saida','data de saida'],
Â  sku: ['sku','codigo','codigo sku','ref','cod'],
Â  qtde: ['qtde','qtd','quantidade','quant'],
Â  prazo_disponibilidade: ['prazo de disponibilidade','prazo','disponibilidade','prazo entrega']
};

function buildHeaderMap(rows){
Â  Â  const first = rows[0] || {};
Â  Â  const originalKeys = Object.keys(first);
Â  Â  const map = {};
Â  Â  for(const [canonical, variants] of Object.entries(headerCandidates)){
Â  Â  Â  Â  let found = null;
Â  Â  Â  Â  for(const orig of originalKeys){
Â  Â  Â  Â  Â  Â  Â if(variants.some(v => normalizeStr(orig) === normalizeStr(v))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â found = orig; break;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(!found){
Â  Â  Â  Â  Â  Â  for(const orig of originalKeys){
Â  Â  Â  Â  Â  Â  Â  Â  const normOrig = normalizeStr(orig);
Â  Â  Â  Â  Â  Â  Â  Â  if(variants.some(v => normOrig.includes(normalizeStr(v)))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  found = orig; break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if(found) map[canonical] = found;
Â  Â  }
Â  Â  return map;
}

function normalizeRows(rows){
Â  Â  const map = buildHeaderMap(rows);
Â  Â  return rows.map(r=>{
Â  Â  Â  Â  const nr = {};
Â  Â  Â  Â  for(const key in map){
Â  Â  Â  Â  Â  Â  nr[key] = r[map[key]];
Â  Â  Â  Â  }
Â  Â  Â  Â  nr._raw = r;
Â  Â  Â  Â  return nr;
Â  Â  });
}

/* ============================================================
Â  Â PROCESSAMENTO E INTERFACE
Â  Â ============================================================ */
function atualizarValorTotal() {
Â  Â  let total = 0;
Â  Â  const possiveisColunas = ['total', 'valor', 'valor total', 'vlr total', 'liquido'];
Â  Â  historico_por_nota.forEach(r => {
Â  Â  Â  Â  let valRaw = 0;
Â  Â  Â  Â  if(r._raw) {
Â  Â  Â  Â  Â  Â  const keys = Object.keys(r._raw);
Â  Â  Â  Â  Â  Â  const keyFound = keys.find(k => possiveisColunas.some(p => normalizeStr(k) === p));
Â  Â  Â  Â  Â  Â  if(keyFound) valRaw = r._raw[keyFound];
Â  Â  Â  Â  }
Â  Â  Â  Â  const valor = parseMoneyRaw(valRaw);
Â  Â  Â  Â  if (!isNaN(valor)) total += valor;
Â  Â  });
Â  Â  document.getElementById("valorTotal").textContent = "Valor Total: " + formatCurrency(total);
}

function atualizarDash(){
Â  Â  if(!pedidos.length) return;
Â  Â  const total = pedidos.length;
Â  Â  const media = pedidos.reduce((a,b)=>a+b.dias,0) / total;
Â  Â  const noPrazo = pedidos.filter(p=>p.dias <= 5).length;
Â  Â  diasMediosEl.textContent = media.toFixed(1);
Â  Â  pedidosNoPrazoEl.textContent = ((noPrazo/total)*100).toFixed(0) + '%';
Â  Â  const counts = { 'RÃ¡pido':0, 'MÃ©dio':0, 'Lento':0 };
Â  Â  pedidos.forEach(p => counts[p.velocidade]++);
Â  Â  
Â  Â  // CHART JS CONFIG (Fixed Height)
Â  Â  const ctx = document.getElementById('velocidadeChart').getContext('2d');
Â  Â  if(chartVelocidade) chartVelocidade.destroy();
Â  Â  
Â  Â  chartVelocidade = new Chart(ctx, {
Â  Â  Â  Â  type: 'doughnut',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: ['RÃ¡pido (â‰¤3 dias)', 'MÃ©dio (4-7 dias)', 'Lento (>7 dias)'],
Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  data: [counts['RÃ¡pido'], counts['MÃ©dio'], counts['Lento']],
Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 0
Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  responsive: true, 
Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  cutout: '70%',
Â  Â  Â  Â  Â  Â  plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }
Â  Â  Â  Â  }
Â  Â  });
Â  Â  atualizarLista();
Â  Â  atualizarAnaliseMensal();
}

/* --- ATUALIZAR LISTA COM FILTROS DE INPUT --- */
// Listeners para atualizar lista em tempo real
filtroVelocidadeEl.addEventListener('change', atualizarLista);
filtroDiasEl.addEventListener('input', atualizarLista);

function atualizarLista(){
Â  Â  listaPedidosEl.innerHTML='';
Â  Â  
Â  Â  // Obter valores dos filtros
Â  Â  const valVelocidade = filtroVelocidadeEl.value; // "Todos", "RÃ¡pido", ...
Â  Â  const valDias = parseInt(filtroDiasEl.value); Â  // NÃºmero ou NaN

Â  Â  // Filtrar a lista global
Â  Â  const listaFiltrada = pedidos.filter(p => {
Â  Â  Â  Â  // Filtro de Velocidade
Â  Â  Â  Â  const matchVel = (valVelocidade === 'Todos') || (p.velocidade === valVelocidade);
Â  Â  Â  Â  
Â  Â  Â  Â  // Filtro de Dias (Exato) - Se o input estiver vazio (NaN), ignora
Â  Â  Â  Â  const matchDias = isNaN(valDias) ? true : (p.dias === valDias);
Â  Â  Â  Â  
Â  Â  Â  Â  return matchVel && matchDias;
Â  Â  });

Â  Â  // Ordenar e Renderizar (Top 50)
Â  Â  const listaFinal = listaFiltrada.sort((a,b)=> b.dias - a.dias).slice(0, 50);

Â  Â  if(listaFinal.length === 0) {
Â  Â  Â  Â  listaPedidosEl.innerHTML = '<li style="text-align:center; color:#999; border:none; background:none;">Nenhum pedido encontrado.</li>';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  listaFinal.forEach(p=>{
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.innerHTML = `<strong>#${p.id}</strong> <span style="float:right; color:${p.velocidade==='RÃ¡pido'?'#10b981':p.velocidade==='MÃ©dio'?'#f59e0b':'#ef4444'}">${p.dias} dias</span>`;
Â  Â  Â  Â  li.onclick = () => mostrarItens(p.id);
Â  Â  Â  Â  listaPedidosEl.appendChild(li);
Â  Â  });
}

function mostrarItens(pid){
Â  Â  listaItens.innerHTML = '';
Â  Â  const itens = produtosEnriquecidos.filter(p => String(p.pedido_internet).trim() === String(pid).trim());
Â  Â  itens.forEach(item => {
Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  li.style.cursor = 'default';
Â  Â  Â  Â  li.innerHTML = `<div>${item.sku} <small>x${item.qtde}</small></div><div style="font-size:11px; color:#64748b;">Prazo: ${item.prazoDisponibilidade}</div>`;
Â  Â  Â  Â  listaItens.appendChild(li);
Â  Â  });
}

function atualizarAnaliseMensal(){
Â  Â  const agrupado = {};
Â  Â  pedidos.forEach(p => {
Â  Â  Â  Â  if(!p.dataSaida) return;
Â  Â  Â  Â  const key = `${p.dataSaida.getFullYear()}-${String(p.dataSaida.getMonth()+1).padStart(2,'0')}`;
Â  Â  Â  Â  if(!agrupado[key]) agrupado[key] = { soma:0, count:0 };
Â  Â  Â  Â  agrupado[key].soma += p.dias;
Â  Â  Â  Â  agrupado[key].count++;
Â  Â  });
Â  Â  const labels = Object.keys(agrupado).sort();
Â  Â  const data = labels.map(k => (agrupado[k].soma / agrupado[k].count).toFixed(1));
Â  Â  const ctx = document.getElementById('graficoMes').getContext('2d');
Â  Â  if(graficoMes) graficoMes.destroy();
Â  Â  
Â  Â  graficoMes = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  Â  datasets: [{ label: 'Dias MÃ©dios de Entrega', data: data, backgroundColor: '#3b82f6', borderRadius: 4 }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: { 
Â  Â  Â  Â  Â  Â  responsive: true, 
Â  Â  Â  Â  Â  Â  maintainAspectRatio: false, 
Â  Â  Â  Â  Â  Â  scales: { y: { beginAtZero: true } }, 
Â  Â  Â  Â  Â  Â  plugins: { legend: { display: false } } 
Â  Â  Â  Â  }
Â  Â  });
}

/* ============================================================
Â  Â OVERLAYS E BOTÃ•ES (MANTIDO)
Â  Â ============================================================ */
function abrirOverlay(id) {
Â  Â  const el = document.getElementById(id);
Â  Â  el.style.display = 'flex';
Â  Â  setTimeout(() => { el.style.opacity = '1'; el.querySelector('.overlay-content').style.transform = 'translateY(0)'; }, 10);
}
function fecharOverlay(id) {
Â  Â  const el = document.getElementById(id);
Â  Â  el.style.opacity = '0'; el.querySelector('.overlay-content').style.transform = 'translateY(-50px)';
Â  Â  setTimeout(() => { el.style.display = 'none'; }, 300);
}

// FunÃ§Ãµes stub/dummy para overlays
function abrirOverlayHistorico(){
    // ImplementaÃ§Ã£o da tela de histÃ³rico aqui
    abrirOverlay('overlayHistorico');
}
function gerarGraficoFaturamento(){
    // LÃ³gica de geraÃ§Ã£o de grÃ¡fico de faturamento aqui
}
function abrirOverlayRecorrencia(){
    // ImplementaÃ§Ã£o da tela de recorrÃªncia aqui
    abrirOverlay('overlayRecorrencia');
}
function processarPlanilhaRecorrencia(){
    // LÃ³gica para processar planilha de recorrÃªncia aqui
}
function renderizarTabelaRecorrencia(){
    // LÃ³gica para renderizar tabela de recorrÃªncia aqui
}
function gerarModelo(modelType){
    log(`RequisiÃ§Ã£o para baixar modelo: ${modelType}`);
    window.otdAPI.generateModel(modelType).then(r => {
        log(r.message);
    }).catch(e => log(`Erro ao gerar modelo: ${e.message}`));
}


/* ============================================================
Â  Â LÃ“GICA DE UPLOAD E IPC (ATUALIZADA)
Â  Â ============================================================ */
const arquivos_upload = { nota: null, produto: null, site: null };
const arquivosMap = { 
    'planilhaNota': 'nota', 
    'planilhaProduto': 'produto', 
    'planilhaSite': 'site' 
};

// 1. Configura listeners para cada input de arquivo
Object.keys(arquivosMap).forEach(id => {
    document.getElementById(id).addEventListener('change', (e) => {
        const file = e.target.files[0];
        const fileKey = arquivosMap[id];
        const span = document.getElementById(`status${fileKey.charAt(0).toUpperCase()+fileKey.slice(1)}`);
        
        if (!file) {
            arquivos_upload[fileKey] = null;
            span.textContent = 'âŒ Pendente'; span.className = 'status-pend';
            checarTodosArquivos();
            return;
        }

        log(`Lendo arquivo: ${file.name} para a chave '${fileKey}'...`);

        const reader = new FileReader();
        reader.onload = (e) => {
            // Remove o prefixo Data URL para obter apenas o Base64
            const base64Data = e.target.result.split(',')[1];
            
            // Envia o Base64 para o Main/Cache via IPC
            window.otdAPI.processFile(fileKey, base64Data)
                .then(response => {
                    if (response.success) {
                        arquivos_upload[fileKey] = file; // Marca como pronto
                        span.textContent = 'âœ… Pronto'; 
                        span.className = 'status-ok';
                        log(`Arquivo '${fileKey}' enviado ao Core com sucesso.`);
                    } else {
                        span.textContent = 'âŒ Erro no envio'; 
                        span.className = 'status-pend';
                        log(`Erro no envio de '${fileKey}': ${response.message}`);
                    }
                    checarTodosArquivos();
                })
                .catch(err => {
                    span.textContent = 'âŒ Erro IPC'; 
                    span.className = 'status-pend';
                    log(`Erro IPC ao enviar '${fileKey}': ${err.message}`);
                    checarTodosArquivos();
                });
        };
        reader.onerror = (e) => {
            span.textContent = 'âŒ Erro de Leitura'; 
            span.className = 'status-pend';
            log(`Erro ao ler o arquivo '${fileKey}': ${e.target.error.name}`);
            checarTodosArquivos();
        };

        reader.readAsDataURL(file);
    });
});

// 2. Habilita o botÃ£o 'Gerar Dashboard'
function checarTodosArquivos() {
    const todosProntos = Object.values(arquivos_upload).every(a => a !== null);
    document.getElementById('gerarAnalise').disabled = !todosProntos;
}

// 3. Dispara o Processamento Final no Core
document.getElementById('gerarAnalise').addEventListener('click', () => {
    fecharOverlay('overlayImport');
    log("Iniciando anÃ¡lise no Core. Disparando handler 'start-processing'...");
    
    // Chama o novo handler IPC que dispara o cÃ¡lculo no Main
    window.otdAPI.startProcessing()
        .then(response => {
            if (response.success) {
                log("Comando de Processamento recebido pelo Core. Aguardando resultados...");
            } else {
                log(`Erro ao iniciar processamento: ${response.message}`);
            }
        })
        .catch(err => {
            log(`Erro IPC ao iniciar processamento: ${err.message}`);
        });
});

// 4. Recebimento de Dados do Core (Electron -> Renderer)
window.otdAPI.onUpdateDashboard((event, data) => {
    log(`Processamento concluÃ­do no Core. Sucesso: ${data.success}`);
    
    if (data.error) {
        log(`ERRO FATAL: ${data.error}`);
    } else if (data.success) {
        // Recebe os dados limpos do Core (OTD_Calculator)
        historico_por_nota = data.historico_por_nota || []; 
        produtosEnriquecidos = data.produtosEnriquecidos || [];
        pedidos = data.pedidos || [];
        pedidosOriginais = [...pedidos]; // Clonar para os filtros
        
        log(`Total de pedidos processados: ${pedidos.length}`);
        
        // Atualiza a interface
        atualizarValorTotal();
        atualizarDash(); 
    }
});


/* ============================================================
Â  Â INICIALIZAÃ‡ÃƒO
Â  Â ============================================================ */
function initialize() {
    log('AplicaÃ§Ã£o iniciada. Carregando dados persistidos...');
    
    // Tenta carregar dados salvos na inicializaÃ§Ã£o
    window.otdAPI.loadOtdData().then(data => {
        if (data && data.pedidos && data.pedidos.length > 0) {
            log('Dados persistidos carregados com sucesso. Restaurando Dashboard.');
            
            // Assume que loadOtdData retorna a mesma estrutura que o onUpdateDashboard
            historico_por_nota = data.historico_por_nota || []; 
            produtosEnriquecidos = data.produtosEnriquecidos || [];
            pedidos = data.pedidos || [];
            pedidosOriginais = [...pedidos];
            
            atualizarValorTotal();
            atualizarDash(); 
        } else {
            log('Nenhum dado persistido encontrado. Aguardando importaÃ§Ã£o.');
        }
    }).catch(e => {
        log(`Erro ao carregar dados: ${e.message}`);
        log('Verifique se o handler load-otd-data estÃ¡ implementado no Main.');
    });
}

document.addEventListener('DOMContentLoaded', initialize);
</script>

</body>
</html>